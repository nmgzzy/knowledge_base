# 本地知识库工具需求文档

## 1. 背景与目标

本项目旨在构建一个离线优先的本地知识库工具，以文件夹树状结构与 Markdown 作为知识载体，以结构化元数据与向量检索作为高效发现能力，并支持多种交互方式（Flutter 前端、Python CLI、大模型直接交互）在一致的数据与检索能力之上工作。

目标：
- 可控：知识资产可读可编辑，可用 Git/备份工具管理
- 可检索：关键词与语义检索结合，快速定位到具体段落
- 可扩展：新增知识与扩展知识树稳定、可增量更新
- 可追溯：回答与检索结果可定位到文件路径与段落范围
- 可组合：多端共享统一索引与检索能力

非目标：
- 不实现云端协作、多人在线编辑、复杂权限系统（可后续扩展）

## 2. 用户与使用场景

用户类型：
- 个人知识管理用户：记录与检索概念、笔记、总结、资料
- 项目型用户：按项目/领域沉淀设计文档、经验、决策记录
- 大模型辅助用户：希望通过自然语言快速获取有出处的答案

典型场景：
- 在目录树中新增一条知识，自动生成/更新元数据与向量索引
- 通过关键词+语义检索找到相关段落，跳转到原文位置
- 通过大模型对话提问，得到带引用的回答与候选资料列表
- 根据已有知识建议新分类位置，将内容落到合适目录并保持一致性

## 3. 总体方案概述

知识以 Markdown 文件存储在文件夹树中。每个目录维护一个目录元数据文件（描述该目录的主题、摘要、标签、关键词、目录规则等）。根目录维护一个全局索引层（汇总所有内容的可检索字段与 chunk 映射），以及向量数据库（以段落 chunk 为粒度存储 embedding，用于语义召回）。检索时采用混合检索（全文/BM25 + 向量）并进行重排，优先保证准确性与可解释性。

## 4. 数据与目录结构需求

### 4.1 知识库根目录结构

根目录必须可被复制/打包后在另一台机器恢复使用。推荐结构（名称可配置）：
- `kb/`：知识树根目录（所有 Markdown 与子目录）
- `kb_index/`：全局索引层（可再生成）
- `kb_vector/`：向量数据（可再生成）
- `kb_config.json`：全局配置（路径、模型、切分参数等）

约束：
- 向量与索引视为缓存，可随时重建；Markdown 与目录元数据是“源数据”
- 所有索引记录必须可追溯到 `path + heading_path + 行号/偏移`

### 4.2 目录元数据文件（目录级）

每个目录下必须存在一个元数据文件（文件名可配置，默认 `meta.json`），用于描述该目录与其内容的结构化信息。需求：
- 必须包含 schema 版本号，允许后续演进
- 支持人工字段与自动生成字段共存
- 可选包含目录类型/角色（用于约束知识树扩展与导航）

建议字段（可调整）：
- `schema_version`
- `title`
- `summary`
- `tags`：人工标签
- `keywords`：自动抽取关键词列表（含来源与置信度）
- `dir_type`：目录类型（领域/项目/人物/概念/资料/日志等）
- `rules`：该目录下文件命名/子目录约束（可选）
- `updated_at`

### 4.3 文档文件（Markdown）

要求：
- 使用 UTF-8 编码
- 标题层级规范（用于 chunk 切分与引用定位）
- 支持可选的 frontmatter（YAML/JSON），用于文档级元数据（如作者、创建时间、标签等）

### 4.4 全局索引层（根目录汇总）

需求：
- 需要一份根级“全局清单索引”，用于快速枚举与检索路由，避免每次遍历整棵树读取所有 `meta.json`
- 索引层需支持增量更新与原子切换，避免半更新损坏

索引必须记录的核心映射：
- `doc_id`、`path`
- `title`、`summary`、`tags/keywords`
- `mtime/hash`：用于变更检测
- `chunks`：chunk 列表（chunk_id、heading_path、start_line/end_line、text_hash）
- `embedding_model` 与 `embedding_version`
- `vector_namespace` 或 `collection` 信息（用于多模型共存）

实现形式可选：
- SQLite（推荐，便于查询与事务）
- JSONL（便于流式与可读性，但查询与事务需要额外设计）

## 5. 检索与问答能力需求

### 5.1 混合检索流程

检索流程必须支持两段式路由：
1) 结构召回：基于目录元数据与全局索引（标题/摘要/tags）缩小候选目录与文档集合
2) 内容召回：基于向量库按 chunk 召回相关段落

召回后必须支持混合与重排：
- 关键词/全文（如 BM25）与向量召回结果合并
- 对 topN 结果进行重排（轻量 reranker 或大模型打分）

### 5.2 Chunk 切分策略

必须支持按段落/标题切分 chunk，而不是只按整篇文档 embedding。需求：
- chunk 默认包含标题路径上下文（例如 `H1 > H2 > H3`）
- chunk 必须可定位到原文范围（行号或字符偏移）
- 支持最大长度与重叠策略（可配置）

### 5.3 输出可追溯（引用）

大模型回答与检索结果必须包含引用信息：
- `path`
- `heading_path`
- `line_range` 或 `offset_range`

### 5.4 多模型与可迁移性

要求：
- embedding 模型可配置并记录到索引
- 支持重建向量库，不依赖单一向量库实现
- 支持并行维护多套向量（例如升级模型时渐进切换）

## 6. 增量更新与一致性需求

### 6.1 变更检测

必须支持增量更新：
- 基于内容 hash（优先）或 mtime+size（备选）检测变化
- 支持新增/修改/删除/移动（rename）四类事件

### 6.2 原子更新与事务

要求：
- 索引更新必须具备事务/原子切换能力
- 向量更新与索引更新需保持一致，允许失败回滚
- 在异常中断后可恢复（通过重建或日志修复）

### 6.3 清理策略

要求：
- 删除/移动文档需级联清理相关 chunk 向量与索引记录
- 存在孤儿向量/索引记录时提供修复能力（扫描并对齐）

## 7. 知识树扩展与结构约束

### 7.1 目录类型与轻量约束

为避免树越长越乱，要求支持目录类型与约束规则：
- 目录可声明 `dir_type`
- 可定义允许的子目录类型、命名模式、默认模板（模板为可选能力）

### 7.2 交叉链接与知识图谱（最小实现）

要求支持从 Markdown 提取链接并建立引用关系：
- 支持标准 Markdown 链接
- 可选支持 wiki link（如 `[[xxx]]`）并解析到路径
- 在索引层保存引用边（source -> target），用于导航与检索增强

## 8. 多交互方式需求

### 8.1 Flutter 前端工具

核心能力：
- 目录树浏览与快速搜索（关键词/语义）
- 文档阅读与引用跳转（定位到段落）
- 新增/编辑知识（Markdown 编辑、选择目录、更新元数据）
- 一键重建/增量更新索引与向量（可显示进度与日志）
- 大模型对话界面（可选），回答必须可点击引用跳转

数据交互要求：
- 通过本地服务或本地库接口访问索引与向量能力
- 交互协议必须稳定（例如 HTTP/JSON 或 gRPC，本地环回）

### 8.2 Python 命令行工具

核心命令（示例）：
- `kb init`：初始化一个知识库根目录结构
- `kb add <path>`：新增或导入文档到知识树
- `kb add <path> --auto`：启用自动分析与归档
- `kb index`：构建或增量更新索引与向量
- `kb search "<query>"`：检索（支持输出引用与候选列表）
- `kb ask "<query>"`：大模型问答（强制引用）
- `kb repair`：修复索引/向量一致性

要求：
- CLI 输出支持纯文本与 JSON（便于脚本集成）
- 支持离线运行（除非启用在线模型/服务）
- `kb add --auto` 行为要求：
  - 调用大模型工具对导入文章生成 `summary` 与 `keywords/tags`（至少摘要与关键词）
  - 基于目录元数据与全局索引，给出推荐归档路径；若目标目录不存在，允许创建必要的目录层级
  - 为目标目录生成或更新目录元数据文件（默认 `meta.json`），并将文档放入合适路径下
  - 自动生成结果必须可复现/可审计：索引中记录使用的模型、提示版本、生成时间与输入文档 hash

### 8.3 大模型直接交互（Agent / API）

能力边界：
- 模型不直接遍历文件系统做全量搜索；优先通过“索引路由 -> chunk 召回”获取上下文
- 对外提供统一的“检索 + 引用”的工具接口，减少幻觉风险

会话要求：
- 支持多轮对话的检索记忆（保存最近候选 doc/chunk）
- 支持“继续阅读/展开上下文/按目录聚类”的交互动作

## 9. 配置与安全性需求

配置项（示例）：
- 知识库根路径、知识树路径
- 索引实现选择（SQLite/JSONL）
- chunk 切分参数（最大长度、重叠、标题策略）
- embedding 模型与版本、向量库实现、检索融合参数
- rerank 策略与阈值
- 大模型 API 配置（用于 `kb add --auto`、`kb ask` 等）：
  - 第一版支持 OpenAI 兼容 API 接口（可配置 `base_url`、`api_key`、`model`、`timeout` 等）
  - `api_key` 默认从环境变量读取，配置文件中避免明文存储（若必须存储需支持本地加密/钥匙串）

安全与隐私：
- 默认不上传任何知识内容
- 日志不得输出敏感内容全文（可配置为仅输出路径与摘要）

## 10. 可观测性与运维体验

要求：
- 所有增量更新动作记录可审计（至少：时间、变更数量、失败原因）
- 提供重建耗时与索引规模统计
- 提供“健康检查”：索引与向量条目数对齐、孤儿记录数量等

## 11. 性能指标（可作为验收参考）

建议指标（可按设备调整）：
- 10k 文档规模下，增量更新 1 篇文档 < 2s（不含外部模型延迟）
- 常规查询检索返回 top20 < 200ms（本地）
- 向量库重建在可接受时间内完成，并可中断恢复

## 12. 验收标准

必须满足：
- 能初始化、导入、增量更新、检索、问答，并返回可追溯引用
- 删除/移动文档后索引与向量一致
- Flutter、Python CLI、大模型交互三种方式共享同一套索引与向量能力
- 向量库与索引可完全重建，源数据仍可用

可选增强：
- 引用关系可视化
- 目录约束与自动归档建议
- 多 embedding 版本并存与灰度切换
