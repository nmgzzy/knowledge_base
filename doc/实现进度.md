# 实现进度（截至当前版本）

本文记录本仓库已实现能力与后续待实现能力，用于对齐 [需求文档.md](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/doc/%E9%9C%80%E6%B1%82%E6%96%87%E6%A1%A3.md) 的迭代路线。第一版不包含 Flutter 工具。

## 1. 已实现（第一版）

### 1.1 Python CLI（可用）

命令集（均支持 `--json` 输出，便于脚本集成）：
- `kb init <kb_root>`：初始化目录结构与配置文件
- `kb add <path> --kb-root <kb_root>`：导入文件或目录
  - `--dest <rel_dir>`：手动指定目标目录（相对 `kb/`）
  - `--auto`：启用 LLM 自动归档（失败自动退化）
  - `--move`：移动源文件（默认复制）
- `kb index --kb-root <kb_root>`：构建或增量更新索引
  - `--rebuild`：重建索引数据库
  - `--embed`：生成并写入 embedding（需要配置 OpenAI-compatible embedding）
- `kb tree --kb-root <kb_root>`：列出知识树文档（支持深度参数）
  - `--depth <N>`：最大目录深度（0=仅根目录；不传则不限制）
- `kb search "<query>" --kb-root <kb_root>`：检索（默认全文；可选语义/融合）
  - `--semantic`：仅语义检索（需要 embedding）
  - `--hybrid`：融合全文+向量（需要 embedding）
- `kb ask "<query>" --kb-root <kb_root>`：问答（强制带引用；需要 OpenAI-compatible chat）
- `kb repair --kb-root <kb_root>`：修复一致性（第一版实现为重建索引）
- `kb doctor --kb-root <kb_root>`：检测 OpenAI-compatible 接口可用性（chat/embeddings）

入口与实现位置：
- CLI 入口：[cli.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/kb/cli.py)、[__main__.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/kb/__main__.py)
- Tree 实现：[tree.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/kb/tree.py)

### 1.2 根目录结构与配置（可复制/可重建）

初始化会创建：
- `_inbox/`：待归档投递箱（先丢原始文件，再用 agent/`kb add --auto` 归档到 `kb/`）
- `kb/`：知识树源数据（Markdown + 目录级 `meta.json`）
- `kb_index/`：SQLite 索引数据库（可重建）
- `kb_vector/`：预留向量缓存目录（第一版主要写入 SQLite 的 embeddings 表）
- `kb_config.json`：全局配置
- `.gitignore`：默认忽略 `kb_index/`、`kb_vector/`、`_inbox/` 等（若不存在则创建，不覆盖）
- `kb_agent_skill.md`：指导 AI agent 操作/整理知识库的 skill 文档（若不存在则创建，不覆盖）

配置与路径解析：
- [config.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/kb/config.py)

### 1.3 Markdown 切分与引用定位（可追溯）

实现点：
- Markdown 按标题栈 + 段落切分为 chunk
- chunk 记录：
  - `heading_path`（例如 `H1 > H2 > H3`）
  - `start_line/end_line`（行号范围）
- `search/ask` 输出引用字段：
  - `path`（相对 `kb/`）
  - `heading_path`
  - `line_range`（`[start_line, end_line]`）

实现位置：
- [markdown.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/kb/markdown.py)
- [search.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/kb/search.py)
- [ask.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/kb/ask.py)

### 1.4 SQLite 全局索引层（FTS5 + 元数据缓存 + 审计）

实现点：
- SQLite schema（第一版）：
  - `docs/chunks/chunk_fts/embeddings/dirs/links/audit_log`
- FTS5 用于全文召回；支持中文查询的基础适配（CJK token 化）
- 增量更新：
  - 基于 `content_hash`（sha256）判断变更
  - 支持新增/修改/删除（删除会级联清理 chunks/fts/embeddings）
- 审计日志：`audit_log` 记录索引行为概览

实现位置：
- [store_sqlite.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/kb/store_sqlite.py)
- [indexer.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/kb/indexer.py)

### 1.5 语义检索与问答（可选，OpenAI-compatible）

实现点：
- OpenAI-compatible HTTP：
  - `POST /v1/embeddings`（用于 `kb index --embed`、`kb search --semantic/--hybrid`）
  - `POST /v1/chat/completions`（用于 `kb ask`、`kb add --auto`）
- `api_key` 默认从环境变量读取（配置项 `openai_compat.api_key_env`）

实现位置：
- [openai_compat.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/kb/openai_compat.py)
- [search.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/kb/search.py)
- [ask.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/kb/ask.py)
- [auto_add.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/kb/auto_add.py)

### 1.6 `kb add --auto` 自动归档（可选，失败自动退化）

实现点：
- 读取目录元数据（限制深度/数量）作为候选目录概览
- 调用 chat 让模型返回严格 JSON（推荐目录、文件名、文档摘要/标签/关键词、目录 meta patch）
- 若未配置模型或调用失败：退化为 inbox 目录归档（保证命令可用）

实现位置：
- [importer.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/kb/importer.py)
- [auto_add.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/kb/auto_add.py)
- [fs_ops.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/kb/fs_ops.py)

### 1.7 测试（单元测试 + 端到端）

实现点：
- 测试框架：Python 标准库 `unittest` + `unittest.mock`
- 单元测试：覆盖核心模块、边界条件与异常场景（SQLite/文件系统/LLM 网络边界均有 stub/mock）
- 端到端测试：覆盖完整最小链路
- 覆盖率（行覆盖）：提供基于标准库 `trace` 的覆盖率汇总脚本（按 `kb.*` 模块输出统计）

覆盖用例（示例）：
- E2E：`init → add → index → search → delete → index → search`
- Index：增量更新/删除检测、`rebuild` 重建、`only_rel_paths` 过滤、embedding 写入与失败回滚
- Store(SQLite)：schema 初始化、FTS 检索、chunks/fts/embeddings/links/audit 的写入与清理
- Search/Ask：FTS/语义/融合检索，问答 sources 格式化与返回结构
- Auto add：LLM JSON 提取、目录 meta patch 写回、`kb add --auto` 失败降级到 inbox
- OpenAI-compatible：鉴权头注入、重试、响应结构异常处理

实现位置：
- 端到端：[test_e2e.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/tests/test_e2e.py)
- 单元测试：
  - [test_bootstrap.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/tests/test_bootstrap.py)
  - [test_config.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/tests/test_config.py)
  - [test_util.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/tests/test_util.py)
  - [test_markdown.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/tests/test_markdown.py)
  - [test_fs_ops.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/tests/test_fs_ops.py)
  - [test_store_sqlite.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/tests/test_store_sqlite.py)
  - [test_indexer.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/tests/test_indexer.py)
  - [test_search.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/tests/test_search.py)
  - [test_ask.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/tests/test_ask.py)
  - [test_openai_compat.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/tests/test_openai_compat.py)
  - [test_auto_add.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/tests/test_auto_add.py)
  - [test_importer.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/tests/test_importer.py)
- 覆盖率脚本：[run_coverage_trace.py](file:///Users/joeyzhao/Documents/indie_dev/knowledge_base/tests/run_coverage_trace.py)

## 2. 待实现（后续迭代）

### 2.1 索引一致性与原子切换（需求 6.2）
- 增量更新与索引切换的更强原子性（例如双库/版本表/临时表切换）
- 更精细的失败回滚与断点恢复（目前主要依赖 SQLite 事务与可重建）

### 2.2 更完整的变更检测（需求 6.1）
- 支持 rename/move 的“同一文件识别”（基于内容 hash 的移动检测）
- 更高效的扫描（缓存目录树状态）

### 2.3 向量后端与性能（需求 5.1/11）
- 当前向量存储在 SQLite `embeddings`，语义检索为全表扫描
- 待引入可插拔向量后端（如独立向量库/ANN 索引）与批量重建工具

### 2.4 重排（rerank）与结构召回（需求 5.1/5.1.1）
- 增加“结构召回”：基于目录 meta / doc 元信息先缩小候选集
- 增加 rerank：轻量 reranker 或 LLM 打分对 topN 结果重排

### 2.5 交叉链接与知识图谱（需求 7.2）
- 目前仅解析并写入 links 表（md link + wiki link 的原始 target）
- 待实现：target 解析到 doc/path 的解析与边可视化/检索增强

### 2.6 `kb repair` 精细修复能力（需求 6.3/10）
- 当前 `repair` 等价于重建索引
- 待实现：
  - 孤儿向量/索引记录扫描与修复
  - 健康检查指标（条目数对齐、孤儿数量等）

### 2.7 安全与可观测性（需求 9/10）
- 更细的日志控制（避免输出敏感内容全文）
- `api_key` 存储策略增强（例如本地加密/钥匙串）

### 2.8 Flutter 前端（需求 8.1）
- 第一版明确不做；后续可基于稳定的本地接口（HTTP/gRPC）接入
